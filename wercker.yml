box: wercker-labs/docker

build:
  steps:
    - script:
        name: 'Build docker image'
        code: |
          docker build -t curtlabs/goapi .
    - zvelo/docker-hub-push@1.0.12:
        username: $DOCKER_USERNAME
        password: $DOCKER_PASS
        email: $DOCKER_EMAIL
        image: $DOCKER_IMAGE

deploy:
  steps:
    - add-to-known_hosts:
        hostname: $SERVER_HOSTNAME
    - add-ssh-key:
        keyname: GCE
    - script:
        name: 'Deploy across environment'
        code: |
          ssh deployer@$SERVER_HOSTNAME 'sudo rm -f /etc/service/goapi'
          ssh deployer@$SERVER_HOSTNAME 'sudo docker pull curtlabs/goapi'
          ssh deployer@$SERVER_HOSTNAME 'sudo docker stop goapi'
          ssh deployer@$SERVER_HOSTNAME 'sudo docker rm goapi'
          ssh deployer@$SERVER_HOSTNAME 'sudo docker run -d -i --name goapi --env-file='/home/deployer/env' -p 127.0.0.1:8080:80 curtlabs/goapi /home/deployer/gosrc/src/github.com/curt-labs/GoAPI/GoAPI -http=:80'
          ssh deployer@$SERVER_HOSTNAME 'sudo ln -s /etc/sv/goapi /etc/service/'
